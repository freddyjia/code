{"version":3,"sources":["assets\\Scripts\\JsTool\\ImageTool.js"],"names":["ImageTool","Get","callback","Compelte","console","log","document","getElementById","click","Init","canvas","createElement","ctx","getContext","tCanvas","tctx","input","style","opacity","type","position","left","fileGet","handler","maxsize","file","files","alert","fileReader","FileReader","onloadend","readyState","DONE","result","length","img","Image","onload","data","Compress","src","readAsDataURL","onchange","id","accept","body","appendChild","initSize","width","height","ratio","Math","sqrt","fillStyle","fillRect","count","nw","nh","i","j","drawImage","ndata","toDataURL"],"mappings":"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","sourceRoot":"/","sourcesContent":["export function ImageTool() \n{ \n\n}\n\nImageTool.Get = function(callback)\n{\n    ImageTool.Compelte = callback;\n    console.log(\"ImageTool.GetImageTool.GetImageTool.Get\")\n    document.getElementById(\"ImageTool\").click()\n}\n\nImageTool.Init = function()\n{\n    //    用于压缩图片的canvas\n    ImageTool.canvas = document.createElement(\"canvas\");\n    ImageTool.ctx = ImageTool.canvas.getContext('2d');\n    //    瓦片canvas\n    ImageTool.tCanvas = document.createElement(\"canvas\");\n    ImageTool.tctx = ImageTool.tCanvas.getContext(\"2d\");\n\n    //<input id=\"file\" type=\"file\" class=\"fileToUpload\" style=\"opacity:0;position:absolute;\" onchange=\"handleFiles(this)\"/> \n    var input = document.createElement(\"input\");\n    input.style.opacity=0;\n    input.type = \"file\";\n    input.style.position=\"absolute\";\n    input.style.left = '-9999px';\n    var fileGet = function(handler){\n        console.log(\"fileGetfileGetfileGetfileGet \" + handler);\n\n        var maxsize = 100 * 1024;\n        var file = input.files[0];\n\n        if (file.type != 'image/png' && file.type != 'image/jpeg')\n        {\n            return alert(\"图片上传格式不正确\");\n        }\n\n        var fileReader = new FileReader();\n\n        fileReader.onloadend = function () {\n\n            if (fileReader.readyState == fileReader.DONE) {\n\n                // 200kb一下直接上传，否则进行压缩\n                if (fileReader.result.length <= maxsize)\n                {\n                    ImageTool.Compelte(fileReader.result);\n                }\n                else\n                {\n                    var img = new Image();\n                    img.onload = function() \n                    {\n                        var data = ImageTool.Compress(img);\n                        ImageTool.Compelte(data);\n                    }\n                    img.src = fileReader.result;\n                }\n                \n            }\n\n        };\n\n        fileReader.readAsDataURL(file);\n    }\n    input.onchange = fileGet;\n    input.id = \"ImageTool\";\n    input.accept = \"image/*\";\n\n    document.body.appendChild (input);\n\n}\n\nImageTool.Compress = function(img)\n{\n    var initSize = img.src.length;\n    var width = img.width;\n    var height = img.height;\n\n    //如果图片大于四百万像素，计算压缩比并将大小压至400万以下\n    var ratio;\n    if ((ratio = width * height / 4000000)>1) {\n        ratio = Math.sqrt(ratio);\n        width /= ratio;\n        height /= ratio;\n    }else {\n        ratio = 1;\n    }\n\n    ImageTool.canvas.width = width;\n    ImageTool.canvas.height = height;\n\n    //铺底色\n    ImageTool.ctx.fillStyle = \"#fff\";\n    ImageTool.ctx.fillRect(0, 0, ImageTool.canvas.width, ImageTool.canvas.height);\n\n    //如果图片像素大于100万则使用瓦片绘制\n    var count;\n    if ((count = width * height / 1000000) > 1) {\n        count = ~~(Math.sqrt(count)+1); //计算要分成多少块瓦片\n\n        //计算每块瓦片的宽和高\n        var nw = ~~(width / count);\n        var nh = ~~(height / count);\n\n        ImageTool.tCanvas.width = nw;\n        ImageTool.tCanvas.height = nh;\n\n        for (var i = 0; i < count; i++) {\n            for (var j = 0; j < count; j++) {\n                ImageTool.tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);\n\n                ImageTool.ctx.drawImage(ImageTool.tCanvas, i * nw, j * nh, nw, nh);\n            }\n        }\n    } else {\n        ImageTool.ctx.drawImage(img, 0, 0, width, height);\n    }\n\n    //进行最小压缩\n    var ndata = ImageTool.canvas.toDataURL('image/jpeg', 0.1);\n\n    console.log('压缩前：' + initSize);\n    console.log('压缩后：' + ndata.length);\n    console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + \"%\");\n\n    ImageTool.tCanvas.width = ImageTool.tCanvas.height = ImageTool.canvas.width = ImageTool.canvas.height = 0;\n\n    return ndata;\n}"]}